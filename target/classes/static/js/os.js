const apiOS = '/api/os';
async function listarOS(){ const res=await fetch(apiOS); const data=await res.json(); const tbody=document.querySelector('#tblOS tbody'); tbody.innerHTML=''; data.forEach(o=>{ const notebook = o.notebook ? (o.notebook.marca+' '+o.notebook.modelo) : ''; const cliente = o.notebook && o.notebook.cliente ? o.notebook.cliente.nome : ''; const tecnico = o.tecnico ? o.tecnico.username : ''; const dataA = o.dataAbertura ? new Date(o.dataAbertura).toLocaleString() : ''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${o.id}</td><td>${notebook}</td><td>${cliente}</td><td>${tecnico}</td><td>${o.status}</td><td>${dataA}</td><td><button onclick="atualizarStatus(${o.id})">Mudar Status</button></td>`; tbody.appendChild(tr); }); }
async function carregarNotebooks(){ const r=await fetch('/api/notebooks'); const d=await r.json(); const sel=document.getElementById('notebookSelect'); if(!sel) return; sel.innerHTML=''; d.forEach(n=> sel.insertAdjacentHTML('beforeend', `<option value="${n.id}">${n.marca} ${n.modelo}</option>`)); }
async function carregarTecnicos(){ const r=await fetch('/api/usuarios'); if(!r.ok) return; const d=await r.json(); const sel=document.getElementById('tecnicoSelect'); if(!sel) return; sel.innerHTML=''; d.forEach(t=> sel.insertAdjacentHTML('beforeend', `<option value="${t.id}">${t.username}</option>`)); }
async function salvarOS(e){ e.preventDefault(); const fd=new FormData(e.target); const obj=Object.fromEntries(fd.entries()); if(!obj.notebookId){ alert('Selecione notebook'); return;} if(!obj.tecnicoId){ alert('Selecione tecnico'); return;} obj.notebook={id:Number(obj.notebookId)}; obj.tecnico={id:Number(obj.tecnicoId)}; delete obj.notebookId; delete obj.tecnicoId; await fetch(apiOS,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)}); window.location='/os-listar.html'; }
async function atualizarStatus(id){ const novo=prompt('Novo status (ABERTA, EM_REPARO, CONCLUIDA):'); if(!novo) return; const r=await fetch(apiOS+'/'+id); const os=await r.json(); os.status=novo; await fetch(apiOS,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(os)}); listarOS(); }
document.addEventListener('DOMContentLoaded',()=>{ if(document.querySelector('#tblOS')) listarOS(); if(document.getElementById('notebookSelect')) carregarNotebooks(); if(document.getElementById('tecnicoSelect')) carregarTecnicos(); const f=document.querySelector('#frmOS'); if(f) f.addEventListener('submit', salvarOS); });
